Revision: 1d35d8c7f016fa264a2d1980ef58e6adea06286f
Patch-set: 4
File: compiler/intrinsics_list.h

24:0-25:69
Wed Nov 09 14:30:27 2016 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 2b19f7c0_087367cb
Bytes: 30
Please bump the image version.

24:0-25:69
Wed Nov 09 17:13:30 2016 +0000
Author: Aart Bik <1074526@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 2b19f7c0_087367cb
UUID: 4bad4bb0_07453c64
Bytes: 39
yes, see my question on Nicolas on that

File: test/559-checker-irreducible-loop/smali/IrreducibleLoop.smali

199:18-199:34
Wed Nov 09 14:30:13 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: eb4b5ffb_9be0abb8
Bytes: 16
Why this change?

199:18-199:34
Wed Nov 09 17:13:30 2016 +0000
Author: Aart Bik <1074526@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: eb4b5ffb_9be0abb8
UUID: 2bd3b749_5b2d5ba9
Bytes: 251
see my query/comment in the original CL

with the original, we can remove the LoadClass  completely as dead, since it cannot throw, is not used, etc.

I hope this keeps the intent, but was not completely sure. Hence my cry for help in the first CL :-)

199:18-199:34
Wed Nov 09 17:25:34 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 2bd3b749_5b2d5ba9
UUID: 4b32ab88_16db1cd2
Bytes: 70
Ah this Ljava/lang/Class can throw, I see. Cryptic. I'd add a comment.

199:18-199:34
Wed Nov 09 17:34:27 2016 +0000
Author: Aart Bik <1074526@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 4b32ab88_16db1cd2
UUID: 2bd3b749_7b91376a
Bytes: 4
Done

File: test/624-checker-stringops/src/Main.java

66:6-66:60
Wed Nov 09 14:30:27 2016 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 2b19f7c0_a86173f2
Bytes: 356
If some intrinsics were just hoisted out of the loop but not eliminated, this would still pass. We should instead

  /// CHECK-NOT: InvokeVirtual intrinsic:StringIndexOf
  /// CHECK-NOT: InvokeVirtual intrinsic:StringIndexOfAfter
  /// CHECK-NOT: InvokeVirtual intrinsic:StringStringIndexOf
  /// CHECK-NOT: InvokeVirtual intrinsic:StringStringIndexOfAfter

66:6-66:60
Wed Nov 09 17:13:30 2016 +0000
Author: Aart Bik <1074526@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 2b19f7c0_a86173f2
UUID: ebafdfaa_c44994a7
Bytes: 130
oh I meant to drop the whole part starting from loop
(since there are no other virtuals)

but your suggestion is a bit more robust

88:99-88:117
Wed Nov 09 14:30:27 2016 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 4b6e2b0f_19f8cfcb
Bytes: 370
Why don't we hoist the null check out of the loop? The InputsAreDefinedBeforeLoop() in LICM says that "[w]e can move an instruction that takes a loop header phi in the environment..." Why doesn't it apply here?

(Though this could actually be a pessimization for implicit null checks that can be merged into the following instruction if that instruction is not hoisted.)

88:99-88:117
Wed Nov 09 17:13:30 2016 +0000
Author: Aart Bik <1074526@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 4b6e2b0f_19f8cfcb
UUID: 2bd3b749_3b085f05
Bytes: 235
LICM never tries due to:

bool found_first_non_hoisted_throwing_instruction_in_loop = !inner->IsLoopHeader();

(i.e. we only hoist out of header to preheader, never out of  loop-body proper). Hmm, maybe we need a loop optimizer.... :-)

88:99-88:117
Wed Nov 09 18:32:08 2016 +0000
Author: Vladimir Marko <1018108@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 2bd3b749_3b085f05
UUID: eb243f49_d33ff4f4
Bytes: 275
I see... We would have to split the header first, so that we branch over if the body is not executed at all:

  while (cond) { ... } -> if (cond) { do { ... } while (cond); }

Then we can hoist certain throwing instructions out of the loop while keeping them inside the "if".

88:99-88:117
Wed Nov 09 18:38:11 2016 +0000
Author: Aart Bik <1074526@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: eb243f49_d33ff4f4
UUID: 2bd3b749_be769d7f
Bytes: 281
In the Intel compiler we converted all loops to these top-tested/bottom-tested forms. Also saves some branching overhead for very tight loops.

I am looking at a few other missed licm cases in our benchmarks as I type this message....


But all beyond the scope of this CL, I hope.

88:99-88:117
Wed Nov 09 19:29:33 2016 +0000
Author: Mingyao Yang <1043514@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 2bd3b749_be769d7f
UUID: cb6cdb83_8a77ebb4
Bytes: 174
In dynamic BCE, we did hoist null checks out with a deoptimization, in order to do some BCE's.

But if we get null check for free with signal mechanism, it's ok not to hoist.

