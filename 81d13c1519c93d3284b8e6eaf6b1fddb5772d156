Revision: 81d13c1519c93d3284b8e6eaf6b1fddb5772d156
Patch-set: 2
File: runtime/oat_file_assistant.cc

187:9-187:19
Thu Nov 03 15:28:25 2016 +0000
Author: Calin Juravle <1022077@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: e641d62c_4ee07312
Bytes: 214
Hard to reason here :P

You can only enter this path if you need compilation because of a filter change, otherwise you would  have already return at L150 or L165. So I think you miss those cases to update the vdex.

187:9-187:19
Thu Nov 03 15:33:45 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: e641d62c_4ee07312
UUID: e641d62c_ee7aff63
Bytes: 96
As discussed all cases above are kNoDexOptNeeded aor patchoat stuff, so I think we're good here.

631:4-631:23
Thu Nov 03 15:36:58 2016 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: a6dd1ea2_dabd030f
Bytes: 4
Why?

631:4-631:23
Thu Nov 03 15:43:12 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: a6dd1ea2_dabd030f
UUID: e641d62c_6e228f6b
Bytes: 74
Because the vdex file wasn't created by this method. I've added a comment.

631:4-631:23
Thu Nov 03 15:44:40 2016 +0000
Author: Andreas Gampe <1041833@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: e641d62c_6e228f6b
UUID: a6dd1ea2_7ab4d71d
Bytes: 120
That is dangerous, though. Can you ensure that it's never gonna be corrupted by a crashing (or randomly killed) dex2oat?

631:4-631:23
Thu Nov 03 15:53:20 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: a6dd1ea2_7ab4d71d
UUID: e641d62c_eeff5f8a
Bytes: 461
Good point.

So the oat file is out of date, therefore no-one can use it. If dex2oat does things in that order:
1) Clear vdex header
2) Update vdex
3) Set vdex header
4) Generate oat

Then a corruption of the existing vdex will make the oat file even less usable. So we should be good, WDYT?

On the other hand, the invariant that we cleanup the mess done by any dex2oat crash is nice to have. So no strong preference here. Would you rather have that invariant?

File: runtime/oat_file_assistant.h

74:4-74:21
Thu Nov 03 15:28:25 2016 +0000
Author: Calin Juravle <1022077@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: e641d62c_aef637df
Bytes: 94
Mention that his implies kDex2OatNeeded? (i.e. the code  for the dex location needs updating).

74:4-74:21
Thu Nov 03 15:33:45 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: e641d62c_aef637df
UUID: e641d62c_ce754375
Bytes: 4
Done

