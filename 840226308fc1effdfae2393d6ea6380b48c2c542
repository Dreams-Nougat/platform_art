Revision: 840226308fc1effdfae2393d6ea6380b48c2c542
Patch-set: 1
File: tools/buildbot-build.sh

22
Fri Oct 21 19:39:44 2016 +0000
Author: Colin Cross <1002751@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 3c913fcf_8875f87b
Bytes: 114
The above check ensures that you are already in ANDROID_BUILD_TOP, no need to require ANDROID_BUILD_TOP to be set.

22
Fri Oct 21 19:49:23 2016 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 3c913fcf_8875f87b
UUID: 3c913fcf_a8e554f0
Bytes: 791
It's also possible to run this script and not run build/envsetup.sh first, I've accidentally tried running scripts like that countless times, it's always safer to have *at least* the ANDROID_BUILD_TOP check.

In which case ANDROID_BUILD_TOP will just expand to empty and the rest of this stuff will fail with more obscure messages.

----------------------------

(Actually I don't really like the above check (L17), it can succeed arbitrarily in any directory that happens to have art in it, but it's better than nothing)

Happy to replace it with an even more robust option if you prefer, something like -z $ANDROID_BUILD_TOP && PWD == ANDROID_BUILD_TOP

Or we can just cd into the ANDROID_BUILD_TOP directory as the first step, it seems pretty arbitrary to require execution from the root.

22
Fri Oct 21 19:56:50 2016 +0000
Author: Colin Cross <1002751@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 3c913fcf_a8e554f0
UUID: 3c913fcf_3bd8b008
Bytes: 338
As far as I can tell, there is no requirement to source build/envsetup.sh before running this script for any reason other than to get ANDROID_BUILD_TOP, which is not used, so it seems strange to require build/envsetup.sh first.  The whole point to using get_build_var is so that you don't need envsetup.sh/lunch before running the script.

22
Fri Oct 21 20:15:22 2016 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 3c913fcf_3bd8b008
UUID: 3c913fcf_3b3ef0f1
Bytes: 522
get_build_var is not exported by envsetup.sh

  aosp_master$ declare -x -F get_build_var
  aosp_master$

That is why we need to re-source envsetup.sh again in this script [even if it was already sourced prior by the user of the script].

------------

I think you are right we could try to look for $PWD/build/envsetup.sh and just source it, however it still needs to lunch into the right thing somehow (and maybe it's a missing step that we check that lunch was actually ran?) or the right target build won't be selected.

22
Fri Oct 21 20:29:04 2016 +0000
Author: Colin Cross <1002751@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 3c913fcf_3b3ef0f1
UUID: dc93c3d8_90db6262
Bytes: 379
You can just set TARGET_PRODUCT and TARGET_VARIANT to build without using lunch, so there still isn't any strict requirement to source build/envsetup.sh before running this script.  You do need to source it inside the script, but if you are requiring running from the top of the build that is easy.

Checking for build/envsetup.sh is probably more reliable than checking for art/

22
Fri Oct 21 20:37:55 2016 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: dc93c3d8_90db6262
UUID: 5c2fd370_8795e61d
Bytes: 508
Does it really work that easily, lunch seems to set a bunch of stuff besides those two variables?


    export TARGET_PRODUCT=$product
    export TARGET_BUILD_VARIANT=$variant
    export TARGET_BUILD_TYPE=release
    export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
    export PATH=...

and so on. 
-------

that being said I noticed it sets ANDROID_HOST_OUT (and ANDROID_PRODUCT_OUT) but not ANDROID_TARGET_OUT so I could also avoid an extra call into the build by using that environment variable instead.

22
Fri Oct 21 20:47:40 2016 +0000
Author: Colin Cross <1002751@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 5c2fd370_8795e61d
UUID: 5c2fd370_071f36d2
Bytes: 151
None of that is necessary, it will all default to sane values.  You only need to set anything you want to override from the defaults (full-eng release)

36
Fri Oct 21 19:39:44 2016 +0000
Author: Colin Cross <1002751@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 3c913fcf_c824607c
Bytes: 76
This isn't necessary, get_build_var TARGET_OUT will already respect $OUT_DIR

36
Fri Oct 21 19:49:23 2016 +0000
Author: Igor Murashkin <1021471@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: 3c913fcf_c824607c
UUID: 3c913fcf_48b5b0d2
Bytes: 25
Thanks for spotting this!

