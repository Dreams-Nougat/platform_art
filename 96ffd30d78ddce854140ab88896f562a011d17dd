Revision: 96ffd30d78ddce854140ab88896f562a011d17dd
Patch-set: 5
File: runtime/instrumentation.cc

883:38-884:93
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 5ad35b96_075c7634
Bytes: 151
It's all temporary, as getting rid of the current_method is one solution from multiple others. I think it's more instrumentation that needs revisiting.

885:1-885:43
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: daa58b1c_ab99e90c
Bytes: 164
Just to be clear: b/33630159 is a workaround until we properly support deopt of runtime callers.

So all in all, I'd just drop the reference of current_method here.

File: runtime/jit/jit_code_cache.cc

629
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: faa88ff5_ecaaeb22
Bytes: 491
Two things that I realize are missing with regards to the JIT:

1) What about methods that get redefined but are not on the stack so we don't create obsolete methods? (I've mentioned that in the original change). I think you need to cleanup stuff for those too.

2) In theory You need to update CHA data structures for obsolete methods. The good news is that CHA only does inlining, which is disabled for debuggable apps. So please add a DCHECK somewhere we don't do CHA for debuggable apps.

640:39-643:75
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: faa88ff5_8ca52755
Bytes: 159
See my comment in the initial change that is sort of done atomically, so I wouldn't bother with making this a TODO. I'd expand the comment about the atomicity.

File: runtime/openjdkjvmti/ti_redefine.cc

79:77-79:87
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 1ac9e3ea_e5aaf622
Bytes: 9
error_msg

118:9-118:13
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: daa58b1c_eb93f1e6
Bytes: 19
Say what "this" is.

158:27-158:77
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 1ac9e3ea_c5affa30
Bytes: 169
Move this to JitCodeCache::MoveObsoleteMethod. Otherwise, you're not handling the profiling info. Also, who knows if the JIT is going to cache more things in the future.

159:63-160:33
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 9ab4f348_51c2b442
Bytes: 67
Drop (and note that MoveObsoleteMethod doesn't update entrypoints).

163:8-163:93
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: daa58b1c_0b8bddb1
Bytes: 64
This looks misplaced. Move it just after line 153? Or just drop?

170:4-170:21
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 1aa00309_4d35f991
Bytes: 29
Move this in the constructor.

256:2-256:48
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 7ab57f43_306568c8
Bytes: 8
Say why.

467:0-474:1
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 5ad35b96_6769f2d2
Bytes: 66
Isn't that only used line 481? I'd inline it there to not pollute.

476:0-476:72
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 1aa00309_adf45dae
Bytes: 47
Add a comment explaining what this method does.

476:16-476:39
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: daa58b1c_6b88a1b3
Bytes: 31
FindAndAllocateObsoleteMethods?

502:16-502:37
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 9ab4f348_91b25ce0
Bytes: 36
Add a comment what this method does.

File: runtime/openjdkjvmti/ti_redefine.h

132:2-132:28
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 9ab4f348_71c53849
Bytes: 29
I don't understand this TODO.

File: runtime/stack.cc

617:0-621:1
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 3aa30717_4e605315
Bytes: 66
Inline this back where it was, you don't need this change anymore.

795
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: faa88ff5_ccaf2f31
Bytes: 90
Revert the change (looking at the left in gerrit, that means make this uint32_t line 797).

859:0-859:83
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: daa58b1c_4b85e597
Bytes: 23
No need to change this.

File: test/916-obsolete-jit/src/Main.java

146:5-149:21
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 9ab4f348_d1ace487
Bytes: 118
You should use ensureJitCompiled early on in the test, and then you are guaranteed to enter doTest with them compiled.

File: test/916-obsolete-jit/src/Transform.java

32:12-32:18
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 3aa30717_ae2bb7b0
Bytes: 7
Revisit

33:11-33:26
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: faa88ff5_2cb5137e
Bytes: 7
once...

35:12-35:16
Fri Dec 16 15:09:43 2016 +0000
Author: Nicolas Geoffray <1038443@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: 1aa00309_cd03a9c0
Bytes: 14
What's "this"?

